{% extends "base.html" %}

{% block title %}Manage Users - SecureTrainer{% endblock %}

{% block content %}
<div class="flex flex-col space-y-6">
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
        </div>
        <input type="text" name="search" value="{{ request.args.get('search', '') }}"
            class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Search by name, email, or username...">
    </div>
</div>
<div class="w-48">
    <select name="department"
        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">All Departments</option>
        <option value="IT" {% if request.args.get('department')=='IT' %}selected{% endif %}>IT</option>
        <option value="HR" {% if request.args.get('department')=='HR' %}selected{% endif %}>HR</option>
        <option value="Finance" {% if request.args.get('department')=='Finance' %}selected{% endif %}>
            Finance</option>
        <option value="Sales" {% if request.args.get('department')=='Sales' %}selected{% endif %}>Sales
        </option>
        <option value="Engineering" {% if request.args.get('department')=='Engineering' %}selected{% endif %}>
            Engineering</option>
    </select>
</div>
<button type="submit" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-md transition">
    Filter
</button>
{% if request.args.get('search') or request.args.get('department') %}
<a href="{{ url_for('admin.manage_users') }}"
    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md transition">
    Clear
</a>
{% endif %}
</form>
</div>

<!-- Users Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                    <th class="p-4 font-semibold">User Info</th>
                    <th class="p-4 font-semibold">Role & Dept</th>
                    <th class="p-4 font-semibold">Progress</th>
                    <th class="p-4 font-semibold">Status</th>
                    <th class="p-4 font-semibold text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for user in users %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4">
                        <div class="flex items-center">
                            <div
                                class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold mr-3">
                                {{ (user.get('first_name', 'U')[0] if user.get('first_name') else 'U') }}{{ (user.get('last_name', 'N')[0] if user.get('last_name') else 'N') }}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">{{ user.get('first_name', 'Unknown') }} {{ user.get('last_name', 'User') }}
                                </div>
                                <div class="text-xs text-gray-500">{{ user.get('email', 'No email') }}</div>
                                <div class="text-xs text-gray-400">@{{ user.get('username', 'anonymous') }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="text-sm text-gray-900">{{ user.get('role', 'Trainee') }}</div>
                        <div class="text-xs text-gray-500">{{ user.get('department', 'N/A') }}</div>
                        {% if user.get('is_admin', False) %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mt-1">
                            Admin
                        </span>
                        {% endif %}
                    </td>
                    <td class="p-4">
                        <div class="text-sm font-medium text-gray-900">Score: {{ user.get('score', 0) }}</div>
                        <div class="text-xs text-gray-500">Level {{ user.get('level', 1) }}</div>
                    </td>
                    <td class="p-4">
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Active
                        </span>
                    </td>
                    <td class="p-4 text-right space-x-2">
                        <a href="{{ url_for('admin.edit_user', user_id=user.get('_id', user.get('id', ''))) }}"
                            class="text-blue-600 hover:text-blue-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{{ url_for('admin.get_user_detailed_analytics', user_id=user.get('_id', user.get('id', ''))) }}"
                            class="text-green-600 hover:text-green-900" title="Analytics">
                            <i class="fas fa-chart-line"></i>
                        </a>
                        <form action="{{ url_for('admin.delete_user', user_id=user.get('_id', user.get('id', ''))) }}" method="POST"
                            class="inline-block"
                            onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                            <button type="submit" class="text-red-600 hover:text-red-900" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="p-8 text-center text-gray-500">
                        No users found matching your criteria.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6">
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    Showing page <span class="font-medium">{{ page }}</span> of <span class="font-medium">{{ (total
                        / 50)|round(0, 'ceil')|int }}</span>
                    (<span class="font-medium">{{ total }}</span> total results)
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if page > 1 %}
                    <a href="{{ url_for('admin.manage_users', offset=(page-2)*50, limit=50, search=request.args.get('search'), department=request.args.get('department')) }}"
                        class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}

                    <a href="#"
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600 hover:bg-blue-100">
                        {{ page }}
                    </a>

                    {% if page * 50 < total %} <a
                        href="{{ url_for('admin.manage_users', offset=page*50, limit=50, search=request.args.get('search'), department=request.args.get('department')) }}"
                        class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                </nav>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}